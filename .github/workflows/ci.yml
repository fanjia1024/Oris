name: CI

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
    tags:
      - 'v0.[0-9]+.[0-9]+'
      - 'v0.[0-9]+.[0-9]+-beta.[0-9]+'
      - 'v0.[0-9]+.[0-9]+-alpha.[0-9]+'
    paths-ignore:
      - 'renovate.json'

jobs:
  cross_platform_smoke:
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
    runs-on: ${{ matrix.os }}
    env:
      RUST_BACKTRACE: 1
      CARGO_BUILD_JOBS: 2
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Free disk space
        if: matrix.os == 'ubuntu-latest'
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          profile: minimal
      - uses: swatinem/rust-cache@v2
        with:
          shared-key: "rust-cross-platform-${{ matrix.os }}"
      - name: Check workspace
        uses: actions-rs/cargo@v1
        with:
          command: check
          args: --workspace --locked
      - name: Check custom node plugins example
        uses: actions-rs/cargo@v1
        with:
          command: check
          args: -p oris-runtime --example custom_node_plugins --locked

  build:
    runs-on: ubuntu-latest
    env:
      RUST_BACKTRACE: 1
      CARGO_BUILD_JOBS: 2
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Get the build metadata
        shell: bash
        run: |
          echo "TAG_VERSION=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV
          echo "CARGO_VERSION=$(grep -m 1 '^version = ' crates/oris-runtime/Cargo.toml | cut -f 3 -d ' ' | tr -d \")" >> $GITHUB_ENV
      - name: Validate git tag and Cargo.toml version
        shell: bash
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          if [ "${{ env.TAG_VERSION }}" != "v${{ env.CARGO_VERSION }}" ]; then
            echo "git tag version (${{ env.TAG_VERSION }}) does not match oris-runtime Cargo.toml version (v${{ env.CARGO_VERSION }})"
            exit 1
          fi
      - name: Free disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true
      - name: install pandoc
        shell: bash
        run: |
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          sudo apt-get update -o Acquire::Retries=3
          sudo apt-get install -y --no-install-recommends pandoc protobuf-compiler || \
          (sleep 5 && sudo apt-get update -o Acquire::Retries=3 && sudo apt-get install -y --no-install-recommends pandoc protobuf-compiler)
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          profile: minimal
          components: rustfmt, clippy
      - uses: swatinem/rust-cache@v2
        with:
          shared-key: "rust-build"
      - name: Rust fmt
        uses: actions-rs/cargo@v1
        with:
          command: fmt
          args: --all -- --check
      - name: Rust clippy
        uses: actions-rs/cargo@v1
        with:
          command: clippy
          args: --all-targets --all-features -- -D warnings
      - name: Rust clippy (Axum starter)
        uses: actions-rs/cargo@v1
        with:
          command: clippy
          args: -p oris_starter_axum --all-targets -- -D warnings
      - name: Build release
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --verbose --all --release --all-features
      - name: Run Test
        uses: actions-rs/cargo@v1
        with:
          command: test
          args: --release --all-features
      - name: Run runtime schema migration regression (sqlite)
        uses: actions-rs/cargo@v1
        with:
          command: test
          args: -p oris-runtime --features "sqlite-persistence,kernel-postgres" kernel::runtime::sqlite_runtime_repository::tests::schema_migration -- --nocapture --test-threads=1
      - name: Run runtime schema migration regression (postgres, env-gated)
        uses: actions-rs/cargo@v1
        with:
          command: test
          args: -p oris-runtime --features "sqlite-persistence,kernel-postgres" kernel::runtime::postgres_runtime_repository::tests::postgres_schema_migration_ -- --nocapture --test-threads=1
      - name: Run backend config startup checks regression
        uses: actions-rs/cargo@v1
        with:
          command: test
          args: -p oris-runtime --features "sqlite-persistence,kernel-postgres" kernel::runtime::backend_config::tests:: -- --nocapture --test-threads=1
      - name: Run scheduler stress regression suite
        uses: actions-rs/cargo@v1
        with:
          command: test
          args: -p oris-runtime --features "sqlite-persistence,execution-server" kernel::runtime::api_handlers::tests::scheduler_stress_ -- --nocapture --test-threads=1
      - name: Check custom node plugins example
        uses: actions-rs/cargo@v1
        with:
          command: check
          args: -p oris-runtime --example custom_node_plugins --locked
      - name: Check execution server example
        uses: actions-rs/cargo@v1
        with:
          command: check
          args: -p oris-runtime --example execution_server --features "sqlite-persistence,execution-server" --locked
      - name: Check Axum starter example
        uses: actions-rs/cargo@v1
        with:
          command: check
          args: -p oris_starter_axum --locked
      - name: Verify cargo-generate templates
        shell: bash
        run: |
          bash scripts/verify_cargo_generate_templates.sh

  security:
    runs-on: ubuntu-latest
    env:
      RUST_BACKTRACE: 1
      CARGO_BUILD_JOBS: 2
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          profile: minimal
      - uses: swatinem/rust-cache@v2
        with:
          shared-key: "rust-security"
      - name: Run security regression tests
        uses: actions-rs/cargo@v1
        with:
          command: test
          args: -p oris-runtime --features "sqlite-persistence,execution-server" kernel::runtime::api_handlers::tests::security_ -- --nocapture --test-threads=1

  runtime_backends:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        backend:
          - sqlite
          - postgres
    env:
      RUST_BACKTRACE: 1
      CARGO_BUILD_JOBS: 2
      ORIS_TEST_POSTGRES_URL: postgres://postgres:postgres@127.0.0.1:5432/oris_test
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: oris_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d oris_test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          profile: minimal
      - uses: swatinem/rust-cache@v2
        with:
          shared-key: "rust-runtime-backends-${{ matrix.backend }}"
      - name: Run crash recovery regression
        uses: actions-rs/cargo@v1
        with:
          command: test
          args: -p oris-runtime graph::persistence::tests::time_travel_tests::test_resume_from_latest_checkpoint -- --nocapture --test-threads=1
      - name: Run sqlite runtime regression suite
        if: matrix.backend == 'sqlite'
        uses: actions-rs/cargo@v1
        with:
          command: test
          args: -p oris-runtime --features "sqlite-persistence" kernel::runtime::sqlite_runtime_repository::tests::schema_migration -- --nocapture --test-threads=1
      - name: Run postgres store regression suite
        if: matrix.backend == 'postgres'
        uses: actions-rs/cargo@v1
        with:
          command: test
          args: -p oris-runtime --features "kernel-postgres" kernel::postgres_store::tests::postgres_ -- --nocapture --test-threads=1
      - name: Run postgres runtime regression suite
        if: matrix.backend == 'postgres'
        uses: actions-rs/cargo@v1
        with:
          command: test
          args: -p oris-runtime --features "sqlite-persistence,kernel-postgres" kernel::runtime::postgres_runtime_repository::tests:: -- --nocapture --test-threads=1

  publish_crate:
    if: startsWith(github.ref, 'refs/tags/')
    needs:
      - cross_platform_smoke
      - build
      - security
      - runtime_backends
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true
      - name: Login to crates.io
        uses: actions-rs/cargo@v1
        with:
          command: login
          args: ${{ secrets.CRATES_TOKEN }}
      - name: Publish oris-runtime to crates.io
        uses: actions-rs/cargo@v1
        with:
          command: publish
          args: -p oris-runtime --all-features
